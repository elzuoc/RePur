<div class="container mx-auto px-4">
  <div class="w-full relative">
    <div
      class="w-full border border-solid border-slate-300 text-slate-300 rounded bg-white z-2"
    >
      <input
        type="hidden"
        class="w-[calc(100%-24px)] inline-block focus:outline-none focus:border focus-visible:border-solid focus:border-slate-400 rounded p-1"
        placeholder="Search..."
      />

      <div
        ref="search"
        class="w-[calc(100%-24px)] inline-block focus:outline-none focus:border focus-visible:border-solid focus:border-slate-400 rounded p-1 text-left"
        contenteditable="true"
        @click="clearSearchInput"
        @blur="initSearchInput"
        @input="filterSearchOptions($event)"
      >
        Search...
      </div>
      <img
        src="@/assets/icons/search.svg"
        class="w-6 inline-block cursor-pointer"
        @click="goSearch"
      />
    </div>

    <div
      id="searchSuggest"
      ref="searchSuggest"
      class="absolute top-9 w-full text-left bg-white p-1 z-20 border border-slate-50 bg-white p-1 text-left shadow-md hidden"
    >
      <div v-for="item in searchOptions" :key="item" class="cursor-pointer">
        <!-- eslint-disable vue/no-v-html -->
        <div @click="changeSearch(item)" v-html="item.name"></div>
        <!-- eslint-enable -->
      </div>
    </div>
  </div>

  <div
    class="w-full border-2 border-dashed border-slate-300 text-slate-300 rounded bg-white p-2 mt-2"
  >
    <div
      class="relative w-full h-20 border border-solid border-slate-300 text-slate-300 rounded bg-zinc-400"
      @click="openNewItemModal"
    >
      <div class="absolute m-auto inset-0 w-fit h-fit">
        <span class="text-white font-bold tracking-wider">+ 常購商品</span>
      </div>
    </div>
  </div>

  <div class="relative w-full mt-4 text-left">
    <div
      ref="sortSelector"
      class="w-fit h-10 p-2 border border-zinc-300 text-zinc-500 cursor-pointer"
      @click="openSortOption"
    >
      <img src="@/assets/icons/sort-desc.svg" class="w-5 inline-block" />
      日期 新→舊
    </div>
    <div
      ref="sortOption"
      class="absolute w-fit h-fit z-20 bg-white/[.95] shadow-md shadow-zinc-300"
      :class="{ block: isSortOpen, hidden: !isSortOpen }"
    >
      <div
        class="p-2 hover:bg-zinc-50 cursor-pointer"
        @click="sortProductList({ event: $event, field: 'buy_date', type: 'desc' })"
      >
        <img src="@/assets/icons/sort-desc.svg" class="w-5 inline-block" />
        日期 新→舊
        <div class="hidden">buy_date-desc</div>
      </div>
      <div
        class="p-2 hover:bg-zinc-50 cursor-pointer"
        @click="sortProductList({ event: $event, field: 'buy_date', type: 'asc' })"
      >
        <img src="@/assets/icons/sort-asc.svg" class="w-5 inline-block" />
        日期 舊→新
        <div class="hidden">buy_date-asc</div>
      </div>
      <!-- <div class="p-2 hover:bg-zinc-50 cursor-pointer" @click="setSortOption($event)">
        <img src="@/assets/icons/sort-desc.svg" class="w-5 inline-block" />
        頻率 多→少
        <div class="hidden">times-desc</div>
      </div>
      <div class="p-2 hover:bg-zinc-50 cursor-pointer" @click="setSortOption($event)">
        <img src="@/assets/icons/sort-asc.svg" class="w-5 inline-block" />
        頻率 少→多
        <div class="hidden">times-asc</div>
      </div>
      <div class="p-2 hover:bg-zinc-50 cursor-pointer" @click="setSortOption($event)">
        <img src="@/assets/icons/view-list.svg" class="w-5 inline-block" />
        年度
      </div>
      <div class="p-2 hover:bg-zinc-50 cursor-pointer" @click="setSortOption($event)">
        <img src="@/assets/icons/star.svg" class="w-5 inline-block" />
        品牌
      </div> -->
    </div>
  </div>

  <div class="w-full mt-4 grid grid-cols-2 gap-2">
    <!-- one product -->
    <!-- <router-link
      v-for="item in products"
      :key="item"
      :to="{
        path: '/ProdDetail',
        name: 'ProdDetail',
        params: { id: item.id },
      }"
    > -->
    <router-link
      v-for="item in products"
      :key="item"
      :to="{
        path: '/ProdDetail',
        name: 'ProdDetail',
        query: { id: item.id },
      }"
    >
      <div class="flex grid grid-cols-3 gap-1 border">
        <div class="flex">
          <!-- 'background-image':
                'url(https://raw.githubusercontent.com/elzuoc/RePur/main/src/assets/uploads/' +
                item.pic +
                ')'-->
          <div
            class="aspect-square bg-zinc-200 w-full"
            :style="{
              'background-image': 'url(' + item.pic + ')',
              'background-size': 'cover',
            }"
          ></div>
        </div>
        <div class="flex col-span-2">
          <div class="flex grid gap-1 text-left">
            <div class="flex h-5 overflow-hidden">
              <span class="font-bold truncate"> {{ item.name }} </span>
            </div>
            <div class="flex">
              <span class="text-xs">
                {{ item.sales_channel_text }}/{{ item.brand }}/{{ item.weight
                }}{{ item.unit }}
              </span>
            </div>
            <div class="flex">
              <span class="text-[0.75rem]">NT$</span>{{ item.price }}
              <div
                v-if="item.discount === '1'"
                class="w-fit h-fit inline-block text-[0.75rem] px-1 bg-amber-500 text-white rounded ml-2"
              >
                特惠活動
              </div>
            </div>
            <div class="flex w-full">
              <span class="text-[0.75rem]">{{ item.buy_date }}</span>
            </div>
          </div>
        </div>
      </div>
    </router-link>
  </div>
</div>

<div
  ref="screenMask"
  class="fixed w-screen h-screen z-10 top-0 left-0 bg-white/[0] backdrop-blur-[1px]"
  :class="{ block: isSortOpen, hidden: !isSortOpen }"
  @click="openSortOption"
></div>

<div
  ref="modalMask"
  class="fixed top-0 left-0 z-10 w-screen h-screen bg-black/[.5] hidden"
></div>
<div
  ref="modal"
  class="fixed m-auto left-0 right-0 top-0 bottom-0 z-20 w-11/12 md:w-8/12 lg:w-5/12 h-fit bg-white rounded border border-zinc-200 hidden transition-all duration-300 ease-in"
  :class="{ 'opacity-0': isModalClose, 'opacity-100': isModalOpen }"
>
  <div class="w-full border-b p-2 font-bold text-left">新增常購商品</div>
  <div class="w-full min-h-[50px] p-2">
    <div class="grid grid-cols-3 gap-2">
      <div class="flex">
        <div class="aspect-square w-full">
          <div
            class="w-full h-full border-2 border-dashed border-slate-300 text-slate-300 rounded bg-white p-2"
          >
            <div
              class="relative w-full h-full border border-solid border-slate-300 text-slate-300 rounded bg-zinc-400"
              @click="openFile"
            >
              <input
                ref="fileInput"
                type="file"
                class="hidden"
                accept="image/*"
                @change="getFileInfo"
              />
              <input
                ref="fileInfo"
                type="text"
                class="hidden"
                placeholder="未選取圖片"
                @click="openFile"
              />
              <input
                ref="fileName"
                v-model="input.img"
                type="text"
                class="hidden"
              />

              <div ref="tempImg" class="absolute m-auto inset-0 w-fit h-fit">
                <span
                  v-if="!dataBase64URL"
                  class="text-white font-bold text-5xl"
                  >+</span
                >
                <img v-if="dataBase64URL" :src="dataBase64URL" class="w-full" />
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="flex col-span-2">
        <div class="grid grid-rows-3 gap-2">
          <div class="flex">
            <input
              v-model="input.name"
              type="text"
              :class="{
                'h-10 w-full border border-zinc-300 rounded focus:outline-none focus:border-2 focus:border-zinc-300 px-2 py-1': true,
                'border-red-400 focus:border-red-400': isVerify && focus.name,
              }"
              placeholder="品名"
              @input="verifyInput"
            />
          </div>
          <div class="flex">
            <input
              v-model="input.brand"
              type="text"
              :class="{
                'h-10 w-full border border-zinc-300 rounded focus:outline-none focus:border-2 focus:border-zinc-300 px-2 py-1': true,
                'border-red-400 focus:border-red-400': isVerify && focus.brand,
              }"
              placeholder="品牌"
              @input="verifyInput"
            />
          </div>
          <div class="flex">
            <input
              v-model="input.capacity"
              type="text"
              class="h-10 w-1/2 border border-zinc-300 rounded focus:outline-none focus:border-2 focus:border-zinc-300 px-2 py-1"
              placeholder="容量/重量"
            />
            <select
              v-model="input.unit"
              class="h-10 w-1/2 border border-zinc-300 rounded focus:outline-none focus:border-2 focus:border-zinc-300 px-2 py-1"
            >
              <option value="" selected disabled>單位</option>
              <option
                v-for="(item, index) in unitOptions"
                :key="index"
                value="item.value"
              >
                {{ item.text }}
              </option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="flex mt-2 w-full">
      <div class="grid grid-rows-2 gap-2 w-full">
        <div class="flex">
          <select
            v-model="input.store"
            class="h-10 w-1/3 border border-zinc-300 rounded focus:outline-none focus:border-2 focus:border-zinc-300 px-2 py-1"
          >
            <option value="" selected disabled>購買處</option>
            <option v-for="item in channels" :key="item" :value="item.id">
              {{ item.shortname }}
            </option>
          </select>
          <input
            v-model="input.price"
            type="number"
            step="0.1"
            :class="{
              'h-10 w-1/3 border border-zinc-300 rounded focus:outline-none focus:border-2 focus:border-zinc-300 px-2 py-1': true,
              'border-red-400 focus:border-red-400': isVerify && focus.price,
            }"
            placeholder="單件金額"
            @input="verifyInput"
          />
          <select
            v-model="input.discount"
            aria-label="discount"
            class="h-10 w-1/3 border border-zinc-300 rounded focus:outline-none focus:border-2 focus:border-zinc-300 px-2 py-1"
          >
            <option selected disabled>優惠？</option>
            <option value="0">日常價</option>
            <option value="1">活動優惠價</option>
          </select>
        </div>
        <div class="flex">
          <input
            v-model="input.date"
            aria-label="date"
            type="date"
            class="h-10 w-full border border-zinc-300 rounded focus:outline-none focus:border-2 focus:border-zinc-300 px-2 py-1"
          />
        </div>
      </div>
    </div>
  </div>
  <div class="w-full border-t p-2">
    <button
      class="rounded py-1 px-2 mb-2 text-white bg-zinc-500 hover:bg-zinc-600 w-fit inline-block float-left"
      @click="closeModal"
    >
      Cancel
    </button>
    <button
      class="rounded py-1 px-2 mb-2 text-white bg-sky-500 hover:bg-sky-600 w-fit inline-block ml-2 float-right"
      @click="saveProduct"
    >
      OK
    </button>
  </div>

  <canvas ref="photoCanvas" width="500" height="500" class="hidden"></canvas>
</div>
